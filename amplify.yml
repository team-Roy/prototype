version: 1
frontend:
  phases:
    preBuild:
      commands:
        - corepack enable
        - corepack prepare pnpm@9.0.0 --activate
        - pnpm install --frozen-lockfile
    build:
      commands:
        - pnpm --filter @fandom/shared build
        - pnpm --filter @fandom/web build
        # 빌드 구조 디버깅
        - echo "=== Build output structure ==="
        - ls -la apps/web/.next/ || true
        - ls -la apps/web/.next/standalone/ || true
        - ls -la apps/web/.next/standalone/apps/web/ || true
        - ls -la apps/web/.next/standalone/apps/web/.next/ || true
        - mkdir -p apps/web/.amplify-hosting/compute/default
        - mkdir -p apps/web/.amplify-hosting/static/_next/static
        - cp apps/web/.next/standalone/apps/web/server.js apps/web/.amplify-hosting/compute/default/
        # package.json에서 workspace: 프로토콜 제거 후 복사
        - 'cat apps/web/.next/standalone/apps/web/package.json | sed ''s/"@fandom\/shared": "workspace:\*",//g'' > apps/web/.amplify-hosting/compute/default/package.json'
        - cp -r apps/web/.next/standalone/apps/web/.next apps/web/.amplify-hosting/compute/default/
        # npm으로 flat node_modules 생성
        - cd apps/web/.amplify-hosting/compute/default && npm install --omit=dev --legacy-peer-deps
        # static 파일은 원래 .next/static에 있음 (standalone 외부)
        - cp -r apps/web/.next/static/. apps/web/.amplify-hosting/static/_next/static/
        - test -d apps/web/public && cp -r apps/web/public/. apps/web/.amplify-hosting/static/ || echo "No public folder"
        - echo "=== node_modules check ==="
        - ls -la apps/web/.amplify-hosting/compute/default/node_modules/ | head -20
        - |
          echo '{"version":1,"routes":[{"path":"/_next/static/*","target":{"kind":"Static"}},{"path":"/*.*","target":{"kind":"Static"},"fallback":{"kind":"Compute","src":"default"}},{"path":"/*","target":{"kind":"Compute","src":"default"}}],"computeResources":[{"name":"default","runtime":"nodejs20.x","entrypoint":"server.js"}],"framework":{"name":"next","version":"14.0.4"}}' > apps/web/.amplify-hosting/deploy-manifest.json
  artifacts:
    baseDirectory: apps/web/.amplify-hosting
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - apps/web/node_modules/**/*
      - apps/web/.next/cache/**/*
